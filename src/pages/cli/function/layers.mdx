export const meta = {
  title: "Reuse code & assets using layers",
  description: "Use Amplify CLI's Lambda layer capability to reuse code & assets across functions.",
};



Lambda layers allow you to pull common code & assets for your Lambda function into a centralized location. With Lambda layers you can:

1. _*Re-use your code & assets*_: Your Lambda functions can leverage these layers to reuse shared code & assets across functions
2. _*Speed up function deployments*_: Iterating on your Lambda function will be significantly faster because it can be independently updated from the layer which usually contains the bulk of large static content

> **Known limitation**: Functions using a layer can't be mocked locally using `amplify mock`. We recommend you to create a dev environment and test the functions inside the AWS Lambda console.

![Lambda layer architecture diagram](/images/layers-architecture.gif)

The general workflow breaks down into the following steps:

1. Create a Lambda layer
2. Add shared code & assets to the layer
3. Add the Lambda layer to a function
4. Deploy the layer & function

## Create a Lambda Layer

To create a layer, run the following command within your Amplify project:

```bash
amplify add function
```

Select `Lambda layer` as the capability to add

```console
? Select which capability you want to add:
> Lambda layer (shared code & resource used across functions)
```

```console
? Provide a name for your Lambda layer: (layer-name)
? Select up to 2 compatible runtimes:
o NodeJS
o Python
```

Next, you'll be guided through a workflow to provide a **layer name**, and select **supported runtimes**. Currently Amplify CLI provides NodeJS and Python runtime support for layers.

```console
? The current AWS account will always have access to this layer.
  Optionally, configure who else can access this layer. (Hit <Enter> to skip)
◯ Specific AWS accounts
◯ Specific AWS organization
◯ Public (everyone on AWS can use this layer)
```

After that, you'll be asked to configure your **layer's permission**.

The **current AWS account will always have access to this layer**.
In addition, the customer can configure access for:

- **Specific AWS accounts**: provide a comma-separated list of AWS Account IDs to provide access to them.
- **Specific AWS organizations**: provide a comma-separated list of AWS Organization IDs to provide access to them. *AWS Organization IDs start with `o-`.*
- **Public**: make this layer available for everyone AWS. Anyone in AWS can reference this layer using its ARN.

```console
Next steps:
Install your libraries in the following folder:
[NodeJS]: amplify/backend/function/<lambda-layer-name>/lib/nodejs/node_modules/...
[Python]: amplify/backend/function/<lambda-layer-name>/lib/python/lib/python3.8/site-packages/...

Include any files you want to share across runtimes in this folder:
amplify/backend/function/<lambda-layer-name>/opt/

"amplify function update <function-name>" - configure a function with this Lambda layer
"amplify push" builds all of your local backend resources and provisions them in the cloud
```

Your Lambda layer is ready to use after the permissions are set up.

## Add shared code & assets

Now that your layer is set up, you'll see a new folder with the `layer-name` added to `amplify/backend/function/`. All compatible runtimes’ folder structure are autogenerated.

### Add shared code

<BlockSwitcher>

<CodeBlock name="NodeJS">

A `nodejs` folder is auto-generated for you. In there you'll find an empty `package.json` file and a `node_modules` folder. If you want to offload other node_modules you can either:

1. `cd` into the `nodejs` folder and run `npm install <required packaged>`
2. move all your existing function's `node_modules` content into the layer's `node_modules` folder

Any node module that is in the layer's `node_modules` folder can be accessed from the function as if the node module is in the function's `node_modules` folder.

*In order to take advantage of Lambda layer's for your NodeJS function, you don't even need to update your function's code!*

</CodeBlock>

<CodeBlock name="Python">

A `python` folder is auto-generated for you. In there you'll find a skeleton folder structure to add your Python packages to. Add your packages to `lib/python3.8/site-packages` folder and then you can use it from within your Python function same as any other `import`.

</CodeBlock>

</BlockSwitcher>

### Add shared assets

Any assets like large images or other files that you want to share across various functions can be placed in the `amplify/backend/function/<layer-name>/opt/` folder. Your function's code can import any assets by looking for files in the `/opt/` path.

### Lambda layer versions

Every time `amplify push` or `amplify update function` is run, Amplify CLI checks if a layer's content has changed and automatically creates a new *layer version*. Layer versions are immutable and functions always use a specific layer version. Therefore when you want your function to leverage new changes from your layer, you have to:

1. Run `amplify update function`
2. Select the `function` capability
3. Follow the guided workflow to configure the latest *layer version*

In order to speed up deployments when vast amount of node_modules exist, Amplify CLI scans only for changes within each module's `package.json` file. If you don't see Amplify CLI detect your latest changes, verify that at least of your node module's `package.json` content has changed.

## Add a layer to a function

You can either create a new function and add Lambda layers by running `amplify add function` or add layers to an existing function using `amplify update function`. Select `Lambda function` when prompted and you'll be presented the following question during the guided flow:

```console
? Do you want to configure Lambda layers for this function? Yes
? Provide existing layers or select layers in this project to access from this function (pick up to 5): (Press <space> to select, <a> to toggle all, <i> to invert selection)
❯◯ Provide existing Lambda Layer ARNs
 ◯ myamplifylayer1
 ◯ myamplifylayer2
```

You can either add an existing layer in AWS by referencing its ARN or select a layer from your Amplify project that's listed below.

When adding a layer from your Amplify project, you'll also be able to select the layer version. Amplify CLI automatically versions your Lambda layers by recognizing changes to the layer's folder contents. The largest layer version number represents the most recent changes.

```console
? Select a version for myamplifylayer1:
*> 8*
  5
  3
  2
  1
```

Given that layers can have overlapping contents, the order of the layer matters. You can adjust the layer's order if needed in the next step.

```console
? Modify the layer order:
(Layers with conflicting files will overwrite contents of layers earlier in the list):
- layer2
- layer3
- layer6
- <ARN1>
- <ARN2>
```

Now, you've successfully added a layer to your function.

## Deploy Lambda layers & functions with Lambda layers

Once you're ready with your changes in your layer and functions, you can deploy them by running `amplify push`.

If a layer’s content has been updated and it has permissions associated, Amplify CLI will prompt you whether you want to carry the permissions forward to a newer version.

```console
Content changes in Lambda layer <layer-name> detected:
Note: You need to run "amplify update function" to configure your functions with the latest layer version.
What permissions do you want to grant to this new layer version?
> The same permission as the latest layer version
> Only accessible by the current account. You can always edit this later with: amplify update function
```

<!-- When a layer's content has been modified, Amplify CLI prompts you if the functions dependent on the layer should update to the latest layer version.

```console
You've updated Lambda layers: layer1, layer2...
Do you want functions using the layers to upgrade to the latest version? (y/N)
``` -->

**Note:** When you update a layer's content, you also need to update the function's that use this layer to use the latest version.

You also have the ability to manually set the layer version that is used by a function. Run `amplify update function` and follow the guided workflow within the `function` capability.

## Update layer content

Any file changes within a layer's folder are automatically tracked by Amplify CLI. If there are changes available, the Amplify CLI will create a new layer version with the changes. Functions that depend on the layer will NOT automatically update to use the new layer version. You can run `amplify update function`, select `Lambda Function` and follow the walkthrough to update the layer version used by a function.

## Update layer settings

You can update any of the layer's settings like its name, runtimes, or permissions by running `amplify update function` and selecting `Lambda layer`.

Next, you'll be prompted to select the layer for which you want to update the settings for.

## Remove a layer

To remove a Lambda layer, run the `amplify function remove` command and select `Lambda layers`. Next, you'll be prompted to select which layer to remove.

> Warning: When you delete a layer, you can no longer configure functions to use it. However, any function that already uses the layer continues to have access to it.

```console
? Choose the resource you would want to remove (Use arrow keys)
> function123 (function)
> function123521 (function)
> layer1223 (layer)
*>** layer1895 **(**layer**)*
> When you delete a layer version, you can no longer configure functions to use it.
> However, any function that already uses the layer version continues to have access to it.
? Are you sure you want to delete the resource? This action deletes all files related to this resource from the backend directory. (N/y)
```
